name: Deploy Backend

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script_stop: true
        script: |
          echo "=== Starting deployment ==="
          cd ~/apps/Prototype-to-MVP-backend
          echo "=== Running git pull ==="
          git pull
          echo "=== Running docker build ==="
          docker build -t backend .
          echo "=== Stopping old container ==="
          docker rm -f backend || true
          echo "=== Starting new container ==="
          docker run -d --name backend -p 127.0.0.1:3001:3001 --env-file .env backend
          echo "=== Deployment complete ==="

